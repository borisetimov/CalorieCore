@model IEnumerable<CalorieCore.DataModels.Recipe>
@{
    var globalRecipes = Model.Where(r => r.IsGlobal).ToList();
    var myRecipes = Model.Where(r => !r.IsGlobal).ToList();
}
<div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center gap-2">
        <h2 class="text-light mb-0">Recipes</h2>
        <img src="~/images/Food.png" alt="Recipes" style="height:38px;">
    </div>

    <a asp-action="Create" class="btn btn-success fw-semibold">
        + Add Recipe
    </a>
</div>

<div class="row">
    @if (myRecipes.Any())
    {
        <h4 class="text-white mt-4">👤 My Recipes</h4>
        <hr class="text-secondary" />

        <div class="row">
            @foreach (var item in myRecipes)
            {
                <div class="col-md-4 mb-4 recipe-card"
                     data-title="@item.Title.ToLower()"
                     data-type="@item.Type.ToLower()"
                     data-difficulty="@item.Difficulty.ToLower()"
                     data-calories="@item.Calories">

                    <div class="card bg-dark text-light h-100 shadow-lg border border-secondary recipe-hover">

                        @if (!string.IsNullOrEmpty(item.Img))
                        {
                            <a asp-action="Details" asp-route-id="@item.Id">
                                <img src="@item.Img" class="card-img-top recipe-card-img" alt="@item.Title">
                            </a>
                        }

                        <div class="card-body d-flex flex-column">

                            <h5 class="fw-semibold mb-2">
                                <a asp-action="Details" asp-route-id="@item.Id"
                                   class="text-decoration-none text-light hover-accent">
                                    @item.Title
                                </a>
                            </h5>

                            <p class="mb-2 text-white">
                                🔥 @item.Calories kcal
                            </p>

                            <div class="mb-3 d-flex flex-wrap gap-2">
                                @if (item.Calories <= 400)
                                {
                                    <span class="badge bg-success">Low-calorie</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">High-calorie</span>
                                }

                                <span class="badge bg-info">@item.Difficulty</span>
                                <span class="badge bg-secondary">@item.Type</span>

                                @if (item.IsFavorite)
                                {
                                    <span class="badge bg-warning text-dark">❤️ Favorite</span>
                                }
                            </div>

                            <div class="mt-auto d-flex flex-wrap gap-2">

                                <form asp-controller="Meals" asp-action="AddFromRecipe" method="post" class="w-100">
                                    <input type="hidden" name="recipeId" value="@item.Id" />
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-outline-success btn-sm w-100">
                                        Cook & Log Meal 🍽
                                    </button>
                                </form>


                                <a asp-action="Edit"
                                   asp-route-id="@item.Id"
                                   class="btn btn-outline-secondary btn-sm">
                                    Edit
                                </a>

                                <a asp-action="Delete"
                                   asp-route-id="@item.Id"
                                   class="btn btn-outline-danger btn-sm">
                                    Delete
                                </a>

                            </div>

                        </div>

                    </div>
                </div>
            }
        </div>
    }

    @if (globalRecipes.Any())
    {
        <h4 class="text-white mt-5">🌍 Global Recipes</h4>
        <hr class="text-secondary" />

        <div class="row">
            @foreach (var item in globalRecipes)
            {
                <div class="col-md-4 mb-4 recipe-card"
                     data-title="@item.Title.ToLower()"
                     data-type="@item.Type.ToLower()"
                     data-difficulty="@item.Difficulty.ToLower()"
                     data-calories="@item.Calories">

                    <div class="card bg-dark text-light h-100 shadow-lg border border-secondary recipe-hover">

                        @if (!string.IsNullOrEmpty(item.Img))
                        {
                            <a asp-action="Details" asp-route-id="@item.Id">
                                <img src="@item.Img" class="card-img-top recipe-card-img" alt="@item.Title">
                            </a>
                        }

                        <div class="card-body d-flex flex-column">

                            <h5 class="fw-semibold mb-2">
                                <a asp-action="Details" asp-route-id="@item.Id"
                                   class="text-decoration-none text-light hover-accent">
                                    @item.Title
                                </a>
                            </h5>

                            <p class="mb-2 text-white">
                                🔥 @item.Calories kcal
                            </p>

                            <div class="mb-3 d-flex flex-wrap gap-2">
                                @if (item.Calories <= 400)
                                {
                                    <span class="badge bg-success">Low-calorie</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">High-calorie</span>
                                }

                                <span class="badge bg-info">@item.Difficulty</span>
                                <span class="badge bg-secondary">@item.Type</span>

                                @if (item.IsFavorite)
                                {
                                    <span class="badge bg-warning text-dark">❤️ Favorite</span>
                                }
                            </div>

                            <div class="mt-auto d-flex flex-wrap gap-2">

                                <form asp-controller="Meals" asp-action="AddFromRecipe" method="post" class="w-100">
                                    <input type="hidden" name="recipeId" value="@item.Id" />
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-outline-success btn-sm w-100">
                                        Cook & Log Meal 🍽
                                    </button>
                                </form>


                                <a asp-action="Edit"
                                   asp-route-id="@item.Id"
                                   class="btn btn-outline-secondary btn-sm disabled"
                                   title="Cannot edit global recipe">
                                    Edit
                                </a>

                                <a asp-action="Delete"
                                   asp-route-id="@item.Id"
                                   class="btn btn-outline-danger btn-sm disabled"
                                   title="Cannot delete global recipe">
                                    Delete
                                </a>

                            </div>

                        </div>

                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        const searchInput = document.getElementById("recipeSearch");
        const filterDropdown = document.getElementById("filterDropdown");
        const cards = document.querySelectorAll(".recipe-card");

        function filterRecipes() {
            const searchValue = searchInput.value.toLowerCase();
            const filterValue = filterDropdown.value;

            let sortedCards = Array.from(cards);

            sortedCards.forEach(card => {
                const title = card.dataset.title;
                const type = card.dataset.type;
                const difficulty = card.dataset.difficulty;

                let visible = title.includes(searchValue);

                if (filterValue.startsWith("type-")) {
                    visible = visible && type === filterValue.replace("type-", "");
                }

                if (filterValue.startsWith("diff-")) {
                    visible = visible && difficulty === filterValue.replace("diff-", "");
                }

                card.style.display = visible ? "" : "none";
            });

            if (filterValue === "cal-low" || filterValue === "cal-high") {
                const container = document.querySelector(".row");

                sortedCards.sort((a, b) => {
                    const calA = parseInt(a.dataset.calories);
                    const calB = parseInt(b.dataset.calories);
                    return filterValue === "cal-low" ? calA - calB : calB - calA;
                });

                sortedCards.forEach(card => container.appendChild(card));
            }
        }

        searchInput.addEventListener("keyup", filterRecipes);
        filterDropdown.addEventListener("change", filterRecipes);
    </script>
}

<style>
    .recipe-card-img {
        height: 200px;
        object-fit: cover;
    }

    .recipe-hover:hover {
        transform: scale(1.02);
        transition: 0.2s ease;
    }

    .hover-accent:hover {
        color: #22c55e !important;
    }
</style>
